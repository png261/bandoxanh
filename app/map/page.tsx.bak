'use client';

import React, { useState, useEffect, useMemo, useRef, Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import { Station, WasteType, RecyclingEvent, BikeRental, VegetarianRestaurant, DonationPoint } from '@/types';
import { MapPinIcon, ChevronDoubleLeftIcon, ChevronDoubleRightIcon, CalendarIcon, DirectionsIcon, LeafIcon, CreditCardIcon, HeartIcon } from '@/components/Icons';
import { useMapStore } from '@/store/mapStore';
import { useSidebar } from '@/hooks/useSidebar';
import { useTheme } from '@/hooks/useTheme';
import { Clock, Info } from 'lucide-react';

export const dynamic = 'force-dynamic';

declare var L: any;

// --- Type Guards ---
const isStation = (item: any): item is Station => 'wasteTypes' in item;
const isEvent = (item: any): item is RecyclingEvent => 'date' in item && 'organizer' in item;
const isBike = (item: any): item is BikeRental => 'instructions' in item && 'price' in item;
const isRestaurant = (item: any): item is VegetarianRestaurant => 'menu' in item && 'priceRange' in item;
const isDonation = (item: any): item is DonationPoint => 'acceptedItems' in item && 'beneficiary' in item;

type AnyLocation = Station | RecyclingEvent | BikeRental | VegetarianRestaurant | DonationPoint;
type ItemWithDistance = AnyLocation & { distance: number | null };

const getDistance = (lat1: number, lon1: number, lat2: number, lon2: number): number => {
  const R = 6371;
  const dLat = (lat2 - lat1) * (Math.PI / 180);
  const dLon = (lon2 - lon1) * (Math.PI / 180);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const d = R * c;
  return d;
};

// --- Icons ---
const getStationIcon = (station: Station, isHovered: boolean = false) => {
  const iconPriority: WasteType[] = [
    WasteType.Electronic, WasteType.Battery, WasteType.Glass, WasteType.Metal,
    WasteType.Plastic, WasteType.Paper, WasteType.Organic, WasteType.General,
  ];
  const primaryType = iconPriority.find(type => station.wasteTypes.includes(type)) || WasteType.General;

  const iconSvgs: Record<WasteType, string> = {
    [WasteType.Electronic]: `<path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-1.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25z" />`,
    [WasteType.Battery]: `<path stroke-linecap="round" stroke-linejoin="round" d="M21 12V7.5a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 7.5v9A2.25 2.25 0 005.25 18.75h13.5A2.25 2.25 0 0021 16.5v-4.5m-19.5-3h1.5M4.5 12h1.5m1.5 0h1.5m1.5 0h1.5m1.5 0h1.5m1.5 0h1.5m1.5 0h1.5" />`,
    [WasteType.Glass]: `<path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 3.545A2.25 2.25 0 0115 5.795v1.5a2.25 2.25 0 01-2.25 2.25h-1.5a2.25 2.25 0 01-2.25-2.25v-1.5A2.25 2.25 0 0112.75 3.545z" />`,
    [WasteType.Metal]: `<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />`,
    [WasteType.Paper]: `<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />`,
    [WasteType.Organic]: `<path stroke-linecap="round" stroke-linejoin="round" d="M14.121 14.121a2.25 2.25 0 113.182-3.182a2.25 2.25 0 01-3.182 3.182zM9.879 9.879a2.25 2.25 0 10-3.182 3.182a2.25 2.25 0 003.182-3.182zM12 21a9 9 0 100-18 9 9 0 000 18z" />`,
    [WasteType.Plastic]: `<path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.125 5.25 5.25 0 011.025 6.075 4.5 4.5 0 11-9.945 4.825z" />`,
    [WasteType.General]: `<path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.125 5.25 5.25 0 011.025 6.075 4.5 4.5 0 11-9.945 4.825z" />`,
  };

  const iconColors: Record<WasteType, string> = {
    [WasteType.Electronic]: 'text-indigo-600 bg-indigo-100', [WasteType.Battery]: 'text-amber-600 bg-amber-100',
    [WasteType.Glass]: 'text-sky-600 bg-sky-100', [WasteType.Metal]: 'text-slate-600 bg-slate-200',
    [WasteType.Paper]: 'text-blue-600 bg-blue-100', [WasteType.Plastic]: 'text-rose-600 bg-rose-100',
    [WasteType.Organic]: 'text-green-600 bg-green-100', [WasteType.General]: 'text-gray-600 bg-gray-200',
  };

  const svgPath = iconSvgs[primaryType];
  const colorClasses = iconColors[primaryType];
  const size = isHovered ? 48 : 40;
  const iconSize = isHovered ? 24 : 20;

  const html = `<div class="${colorClasses} rounded-full flex items-center justify-center border-4 border-white shadow-lg transition-all duration-200" style="width: ${size}px; height: ${size}px; transform: ${isHovered ? 'scale(1.2)' : 'scale(1)'};"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: ${iconSize}px; height: ${iconSize}px;">${svgPath}</svg></div>`;
  return L.divIcon({ html, className: '', iconSize: [size, size], iconAnchor: [size / 2, size], popupAnchor: [0, -size] });
};

const getEventIcon = (_event: RecyclingEvent, isHovered: boolean = false) => {
  const svgPath = `<path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18" />`;
  const colorClasses = 'text-purple-600 bg-purple-100';
  const size = isHovered ? 48 : 40;
  const iconSize = isHovered ? 24 : 20;
  const html = `<div class="${colorClasses} rounded-full flex items-center justify-center border-4 border-white shadow-lg transition-all duration-200" style="width: ${size}px; height: ${size}px; transform: ${isHovered ? 'scale(1.2)' : 'scale(1)'};"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: ${iconSize}px; height: ${iconSize}px;">${svgPath}</svg></div>`;
  return L.divIcon({ html, className: '', iconSize: [size, size], iconAnchor: [size / 2, size], popupAnchor: [0, -size] });
};

const getBikeIcon = (_bike: BikeRental, isHovered: boolean = false) => {
  const svgPath = `<path d="M12.5 4a1 1 0 110-2 1 1 0 010 2zM12 2a2 2 0 100 4 2 2 0 000-4z" /><path d="M14.5 9.5L13 6h-2l-1.5 3.5-3 1L6 10l.5-1.5 5-2H13l3.5 1.5L16 9l-1.5.5z" /><path d="M6.5 13a2.5 2.5 0 100 5 2.5 2.5 0 000-5zm-3.5 2.5a3.5 3.5 0 117 0 3.5 3.5 0 01-7 0zM17.5 13a2.5 2.5 0 100 5 2.5 2.5 0 000-5zm-3.5 2.5a3.5 3.5 0 117 0 3.5 3.5 0 01-7 0z" />`;
  const colorClasses = 'text-cyan-600 bg-cyan-100';
  const size = isHovered ? 48 : 40;
  const iconSize = isHovered ? 24 : 20;
  const html = `<div class="${colorClasses} rounded-full flex items-center justify-center border-4 border-white shadow-lg transition-all duration-200" style="width: ${size}px; height: ${size}px; transform: ${isHovered ? 'scale(1.2)' : 'scale(1)'};"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: ${iconSize}px; height: ${iconSize}px;">${svgPath}</svg></div>`;
  return L.divIcon({ html, className: '', iconSize: [size, size], iconAnchor: [size / 2, size], popupAnchor: [0, -size] });
};

const getRestaurantIcon = (_rest: VegetarianRestaurant, isHovered: boolean = false) => {
  const svgPath = `<path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V11a1 1 0 11-2 0V5.73A1.99 1.99 0 0112 2zM9 2a1 1 0 00-1 1v5h2V3a1 1 0 00-1-1zm6 0a1 1 0 00-1 1v5h2V3a1 1 0 00-1-1zM6.5 11.5a.5.5 0 00-.5.5v3.5a1.5 1.5 0 001.5 1.5h8a1.5 1.5 0 001.5-1.5V12a.5.5 0 00-.5-.5h-10z" />`;
  // Leaf Icon for vegetarian
  const leaf = `<path d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" /><path d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" />`;

  const colorClasses = 'text-orange-600 bg-orange-100';
  const size = isHovered ? 48 : 40;
  const iconSize = isHovered ? 24 : 20;
  const html = `<div class="${colorClasses} rounded-full flex items-center justify-center border-4 border-white shadow-lg transition-all duration-200" style="width: ${size}px; height: ${size}px; transform: ${isHovered ? 'scale(1.2)' : 'scale(1)'};"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: ${iconSize}px; height: ${iconSize}px;">${leaf}</svg></div>`;
  return L.divIcon({ html, className: '', iconSize: [size, size], iconAnchor: [size / 2, size], popupAnchor: [0, -size] });
};

const getDonationIcon = (_point: DonationPoint, isHovered: boolean = false) => {
  const heart = `<path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />`;
  const colorClasses = 'text-pink-600 bg-pink-100';
  const size = isHovered ? 48 : 40;
  const iconSize = isHovered ? 24 : 20;
  const html = `<div class="${colorClasses} rounded-full flex items-center justify-center border-4 border-white shadow-lg transition-all duration-200" style="width: ${size}px; height: ${size}px; transform: ${isHovered ? 'scale(1.2)' : 'scale(1)'};"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: ${iconSize}px; height: ${iconSize}px;">${heart}</svg></div>`;
  return L.divIcon({ html, className: '', iconSize: [size, size], iconAnchor: [size / 2, size], popupAnchor: [0, -size] });
};


// --- Map Component ---
const MapComponent: React.FC<{
  items: ItemWithDistance[];
  hoveredItemId: number | null;
  userLocation: { lat: number; lng: number } | null;
  focusedItem: ItemWithDistance | null;
}> = ({ items, hoveredItemId, userLocation, focusedItem }) => {
  const mapRef = useRef<any>(null);
  const itemMarkersRef = useRef<any>({});
  const userMarkerRef = useRef<any>(null);

  useEffect(() => {
    if (mapRef.current) return;
    const map = L.map('map-container').setView([21.0227, 105.8521], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);
    mapRef.current = map;
    setTimeout(() => map.invalidateSize(), 100);
  }, []);

  useEffect(() => {
    const handleResize = () => mapRef.current?.invalidateSize();
    window.addEventListener('resize', handleResize);
    setTimeout(() => mapRef.current?.invalidateSize(), 250);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    const map = mapRef.current;
    if (!map) return;
    Object.values(itemMarkersRef.current).forEach((marker: any) => marker.remove());
    itemMarkersRef.current = {};

    items.forEach(item => {
      let icon;
      let popupContent = '';
      const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.address)}`;
      const directionsButton = `<div class="mt-3 pt-2 border-t border-gray-200"><a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 font-semibold text-sm hover:underline flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M21.71 11.29l-9-9a1 1 0 0 0-1.42 0l-9 9a1 1 0 0 0 0 1.42l9 9a1 1 0 0 0 1.42 0l9-9a1 1 0 0 0 0-1.42zM14 14.5V12h-4v3H8v-4c0-.6.4-1 1-1h5V7.5l3.5 3.5-3.5 3.5z"/></svg>Ch·ªâ ƒë∆∞·ªùng</a></div>`;

      if (isStation(item)) {
        icon = getStationIcon(item, false);
        popupContent = `
          <div class="w-64 bg-white rounded-xl shadow-md overflow-hidden font-sans">
             <img src="${item.image || 'https://placehold.co/600x400/22c55e/white?text=Tr·∫°m+thu+gom'}" class="w-full h-32 object-cover" />
            <div class="p-3 space-y-2">
              <h3 class="font-bold text-sm text-green-700">${item.name}</h3>
              <p class="text-xs text-gray-600">${item.address}</p>
              <div class="flex flex-wrap gap-1">${item.wasteTypes.map(t => `<span class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded-full">${t}</span>`).join('')}</div>
              ${directionsButton}
            </div>
          </div>`;
      } else if (isEvent(item)) {
        icon = getEventIcon(item, false);
        popupContent = `
          <div class="w-64 bg-white rounded-xl shadow-md overflow-hidden font-sans">
            <img src="${item.image || 'https://placehold.co/600x400/a855f7/white?text=S·ª±+ki·ªán'}" class="w-full h-32 object-cover" />
            <div class="p-3 space-y-2">
              <h3 class="font-bold text-sm text-purple-700">${item.name}</h3>
              <p class="text-xs text-gray-600">${item.address}</p>
              <div class="text-xs text-gray-500"><p><strong>Time:</strong> ${item.date} - ${item.time}</p></div>
              ${directionsButton}
            </div>
          </div>`;
      } else if (isBike(item)) {
        icon = getBikeIcon(item, false);
        popupContent = `
          <div class="w-64 bg-white rounded-xl shadow-md overflow-hidden font-sans">
            <img src="${item.image}" class="w-full h-32 object-cover" onError="this.src='https://placehold.co/600x400/06b6d4/white?text=Xe+ƒë·∫°p'" />
            <div class="p-3 space-y-2">
              <h3 class="font-bold text-sm text-cyan-700">${item.name}</h3>
              <p class="text-xs text-gray-600">${item.address}</p>
              <p class="text-xs font-bold text-cyan-600">${item.price}</p>
              <p class="text-[10px] text-gray-500 line-clamp-2">${item.instructions}</p>
              ${directionsButton}
            </div>
          </div>`;
      } else if (isRestaurant(item)) {
        icon = getRestaurantIcon(item, false);
        popupContent = `
          <div class="w-64 bg-white rounded-xl shadow-md overflow-hidden font-sans">
            <img src="${item.image}" class="w-full h-32 object-cover" onError="this.src='https://placehold.co/600x400/ea580c/white?text=Nh√†+h√†ng'" />
            <div class="p-3 space-y-2">
              <h3 class="font-bold text-sm text-orange-700">${item.name}</h3>
              <p class="text-xs text-gray-600">${item.address}</p>
              <p class="text-xs font-bold text-orange-600">${item.priceRange}</p>
              <p class="text-[10px] text-gray-500 line-clamp-2">${item.menu}</p>
              ${directionsButton}
            </div>
          </div>`;
      } else if (isDonation(item)) {
        icon = getDonationIcon(item, false);
        popupContent = `
          <div class="w-64 bg-white rounded-xl shadow-md overflow-hidden font-sans">
            <img src="${item.image}" class="w-full h-32 object-cover" onError="this.src='https://placehold.co/600x400/db2777/white?text=T·ª´+thi·ªán'" />
            <div class="p-3 space-y-2">
              <h3 class="font-bold text-sm text-pink-700">${item.name}</h3>
              <p class="text-xs text-gray-600">${item.address}</p>
              <p class="text-xs text-gray-500"><strong>Nh·∫≠n:</strong> ${item.acceptedItems}</p>
              <p class="text-xs text-gray-500"><strong>Cho:</strong> ${item.beneficiary}</p>
              ${item.beneficiaryImage ? `<img src="${item.beneficiaryImage}" class="w-8 h-8 rounded-full float-right border border-gray-200" title="Ng∆∞·ªùi nh·∫≠n" />` : ''}
              ${directionsButton}
            </div>
          </div>`;
      }

      const marker = L.marker([item.lat, item.lng], { icon }).addTo(map);
      marker.bindPopup(popupContent);
      itemMarkersRef.current[item.id] = marker;
    });
  }, [items]);

  useEffect(() => {
    const map = mapRef.current;
    if (!map || !userLocation) return;
    if (userMarkerRef.current) {
      userMarkerRef.current.setLatLng([userLocation.lat, userLocation.lng]);
    } else {
      const userIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
      userMarkerRef.current = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon }).addTo(map).bindPopup('V·ªã tr√≠ c·ªßa b·∫°n');
      map.panTo([userLocation.lat, userLocation.lng]);
    }
  }, [userLocation]);

  useEffect(() => {
    Object.entries(itemMarkersRef.current).forEach(([id, marker]: [string, any]) => {
      const itemId = parseInt(id, 10);
      const isHovered = itemId === hoveredItemId;
      const item = items.find(s => s.id === itemId);
      if (item) {
        if (isStation(item)) marker.setIcon(getStationIcon(item, isHovered));
        else if (isEvent(item)) marker.setIcon(getEventIcon(item, isHovered));
        else if (isBike(item)) marker.setIcon(getBikeIcon(item, isHovered));
        else if (isRestaurant(item)) marker.setIcon(getRestaurantIcon(item, isHovered));
        else if (isDonation(item)) marker.setIcon(getDonationIcon(item, isHovered));

        marker.setZIndexOffset(isHovered ? 1000 : 0);
      }
    });
  }, [hoveredItemId, items]);

  useEffect(() => {
    if (focusedItem && mapRef.current && itemMarkersRef.current[focusedItem.id]) {
      const marker = itemMarkersRef.current[focusedItem.id];
      mapRef.current.flyTo([focusedItem.lat, focusedItem.lng], 15, { animate: true, duration: 1 });
      marker.openPopup();
    }
  }, [focusedItem]);

  return <div id="map-container" className="w-full h-full" />;
};

// --- Generic List Item Card (Simplified for sidebar) ---
const InfoCard = ({ item, onClick }: { item: ItemWithDistance, onClick: () => void }) => {
  let colorClass, Icon, details;

  if (isStation(item)) { colorClass = 'text-green-700 bg-green-50 border-green-200'; Icon = MapPinIcon; details = item.wasteTypes.join(', '); }
  else if (isEvent(item)) { colorClass = 'text-purple-700 bg-purple-50 border-purple-200'; Icon = CalendarIcon; details = item.date; }
  else if (isBike(item)) { colorClass = 'text-cyan-700 bg-cyan-50 border-cyan-200'; Icon = Info; details = item.price; }
  else if (isRestaurant(item)) { colorClass = 'text-orange-700 bg-orange-50 border-orange-200'; Icon = LeafIcon; details = item.priceRange; }
  else if (isDonation(item)) { colorClass = 'text-pink-700 bg-pink-50 border-pink-200'; Icon = HeartIcon; details = 'T·ª´ thi·ªán'; }
  else { colorClass = 'text-gray-700'; Icon = MapPinIcon; details = ''; }

  return (
    <div onClick={onClick} className={`group p-4 rounded-3xl border-2 ${colorClass} hover:shadow-lg cursor-pointer transition-all bg-white dark:bg-gray-800 dark:border-gray-700 mb-4 transform hover:scale-[1.02]`}>
      <div className="flex justify-between items-start mb-2">
        <h4 className="font-extrabold text-lg text-gray-800 dark:text-white line-clamp-1 group-hover:text-brand-green transition-colors">{item.name}</h4>
        {item.distance && <span className="text-xs font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2.5 py-1 rounded-full whitespace-nowrap">{item.distance.toFixed(1)} km</span>}
      </div>

      <p className="text-sm text-gray-500 dark:text-gray-400 mb-3 line-clamp-1 flex items-center gap-1.5 font-medium">
        <MapPinIcon className="w-4 h-4 flex-shrink-0" /> {item.address}
      </p>

      {details && (
        <div className="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white/50 dark:bg-black/20 text-xs font-bold uppercase tracking-wider opacity-90">
          <Icon className="w-4 h-4" /> {details}
        </div>
      )}
    </div>
  )
}

const MapPage = () => {
  const searchParams = useSearchParams();
  const MAX_DISTANCE = 20;
  const [searchTerm, setSearchTerm] = useState('');
  const [userLocation, setUserLocation] = useState<{ lat: number; lng: number } | null>(null);
  const [hoveredItemId, setHoveredItemId] = useState<number | null>(null);
  const [isPanelOpen, setIsPanelOpen] = useState(true);
  const [focusedItem, setFocusedItem] = useState<ItemWithDistance | null>(null);

  // View Modes: all, stations, events, bikes, food, donation
  const [viewMode, setViewMode] = useState<'all' | 'stations' | 'events' | 'bikes' | 'food' | 'donation'>('all');
  const [distanceFilter, setDistanceFilter] = useState<number>(MAX_DISTANCE);

  const { stations, events, bikes, restaurants, donationPoints, loading, fetchStations, fetchEvents, fetchBikes, fetchRestaurants, fetchDonationPoints } = useMapStore();

  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
    fetchStations();
    fetchEvents();
    fetchBikes();
    fetchRestaurants();
    fetchDonationPoints();
  }, []);

  useEffect(() => {
    navigator.geolocation.getCurrentPosition(
      (pos) => setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
      (err) => console.error(err)
    );
  }, []);

  const itemsWithDistance = useMemo(() => {
    // Combine all based on filter
    let all: AnyLocation[] = [];
    if (viewMode === 'all') all = [...stations, ...events, ...bikes, ...restaurants, ...donationPoints];
    else if (viewMode === 'stations') all = stations;
    else if (viewMode === 'events') all = events;
    else if (viewMode === 'bikes') all = bikes;
    else if (viewMode === 'food') all = restaurants;
    else if (viewMode === 'donation') all = donationPoints;

    return all.map(item => ({
      ...item,
      distance: userLocation ? getDistance(userLocation.lat, userLocation.lng, item.lat, item.lng) : null,
    }));
  }, [viewMode, userLocation, stations, events, bikes, restaurants, donationPoints]);

  const filteredItems = useMemo(() => {
    return itemsWithDistance
      .filter((item) => {
        const matchesSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          item.address.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesDistance = item.distance === null || item.distance <= distanceFilter;
        return matchesSearch && matchesDistance;
      })
      .sort((a, b) => (a.distance || 999) - (b.distance || 999));
  }, [itemsWithDistance, searchTerm, distanceFilter]);

  const categories = [
    { id: 'all', label: 'T·∫•t c·∫£', icon: <MapPinIcon className="w-6 h-6" />, activeClass: 'bg-gray-800 text-white', inactiveClass: 'bg-gray-100 text-gray-400' },
    { id: 'stations', label: 'Tr·∫°m r√°c', icon: <LeafIcon className="w-6 h-6" />, activeClass: 'bg-green-600 text-white', inactiveClass: 'bg-green-50 text-green-600' },
    { id: 'events', label: 'S·ª± ki·ªán', icon: <CalendarIcon className="w-6 h-6" />, activeClass: 'bg-purple-600 text-white', inactiveClass: 'bg-purple-50 text-purple-600' },
    { id: 'bikes', label: 'Xe ƒë·∫°p', icon: <DirectionsIcon className="w-6 h-6" />, activeClass: 'bg-cyan-600 text-white', inactiveClass: 'bg-cyan-50 text-cyan-600' },
    { id: 'food', label: 'ƒÇn chay', icon: <LeafIcon className="w-6 h-6" />, activeClass: 'bg-orange-600 text-white', inactiveClass: 'bg-orange-50 text-orange-600' },
    { id: 'donation', label: 'T·ª´ thi·ªán', icon: <HeartIcon className="w-6 h-6" />, activeClass: 'bg-pink-600 text-white', inactiveClass: 'bg-pink-50 text-pink-600' },
  ] as const;

  return (
    <div className="flex flex-col md:flex-row h-full w-full relative">
      {/* Sidebar Panel */}
      <div className={`
          absolute inset-x-0 bottom-0 top-auto h-[60vh] md:h-full md:static md:w-[400px] 
          bg-white border-t md:border-t-0 md:border-r border-gray-200 
          z-30 flex flex-col transition-transform duration-300 shadow-2xl md:shadow-none
          rounded-t-3xl md:rounded-none
          ${isPanelOpen ? 'translate-y-0 md:translate-x-0' : 'translate-y-[calc(100%-80px)] md:-translate-x-full md:translate-y-0'}
      `}>

        {/* Toggle Handle (Mobile) */}
        <div
          className="md:hidden w-full flex justify-center pt-3 pb-1 cursor-pointer"
          onClick={() => setIsPanelOpen(!isPanelOpen)}
        >
          <div className="w-12 h-1.5 bg-gray-300 rounded-full"></div>
        </div>

        <div className="p-5 border-b border-gray-100 bg-white md:bg-gray-50/50">
          <h2 className="text-2xl font-black text-gray-800 mb-4 hidden md:block">B·∫£n ƒê·ªì Xanh üåè</h2>

          <div className="relative">
            <input
              type="text"
              placeholder="T√¨m ƒë·ªãa ƒëi·ªÉm..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-12 pr-4 py-4 rounded-2xl border-none bg-gray-100 focus:bg-white focus:ring-4 focus:ring-brand-green/20 outline-none transition-all shadow-sm text-lg font-medium"
            />
            <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
              <MapPinIcon className="w-6 h-6" />
            </div>
          </div>

          <div className="flex gap-3 mt-6 overflow-x-auto pb-2 no-scrollbar snap-x">
            {categories.map(cat => (
              <button
                key={cat.id}
                onClick={() => setViewMode(cat.id as any)}
                className={`
                    flex flex-col items-center justify-center min-w-[80px] p-3 rounded-2xl transition-all snap-start
                    ${viewMode === cat.id ? cat.activeClass + ' shadow-lg scale-105' : cat.inactiveClass + ' hover:bg-gray-200'}
                `}
              >
                <div className="mb-1">{cat.icon}</div>
                <span className="text-xs font-bold">{cat.label}</span>
              </button>
            ))}
          </div>

          {userLocation && (
            <div className="mt-6">
              <div className="flex justify-between text-sm font-bold text-gray-500 mb-2">
                <span>B√°n k√≠nh t√¨m ki·∫øm</span>
                <span className="text-brand-green">{distanceFilter} km</span>
              </div>
              <input
                type="range"
                min="1"
                max="50"
                value={distanceFilter}
                onChange={(e) => setDistanceFilter(Number(e.target.value))}
                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-brand-green"
              />
            </div>
          )}
        </div>

        <div className="flex-1 overflow-y-auto p-4 bg-gray-50/30">
          <p className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 px-2">
            T√¨m th·∫•y {filteredItems.length} ƒë·ªãa ƒëi·ªÉm
          </p>
          <div className="space-y-4 pb-20 md:pb-0">
            {filteredItems.map(item => (
              <div key={item.id} onMouseEnter={() => setHoveredItemId(item.id)} onMouseLeave={() => setHoveredItemId(null)}>
                <InfoCard item={item} onClick={() => {
                  setFocusedItem(item);
                  if (window.innerWidth < 768) setIsPanelOpen(false); // Close panel on mobile selection
                }} />
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Toggle Button (Desktop) */}
      <button
        onClick={() => setIsPanelOpen(!isPanelOpen)}
        className={`hidden md:flex absolute top-1/2 -translate-y-1/2 z-20 bg-white p-3 rounded-r-2xl shadow-xl border border-gray-100 text-gray-500 hover:text-brand-green hover:pl-4 transition-all ${isPanelOpen ? 'left-[400px]' : 'left-0'}`}
      >
        {isPanelOpen ? <ChevronDoubleLeftIcon className="w-6 h-6" /> : <ChevronDoubleRightIcon className="w-6 h-6" />}
      </button>

      {/* Map */}
      <div className="flex-grow h-full relative z-10 w-full">
        {/* <MapComponent
          items={filteredItems}
          hoveredItemId={hoveredItemId}
          userLocation={userLocation}
          focusedItem={focusedItem}
        /> */}
      </div>
    </div>
  );
}

export default MapPage;
